/**
 * This ruleset enforces a security model for an internal school choir management application.
 *
 * Core Philosophy:
 * The security model is based on an "Authenticated Access" principle. It assumes that any user who has successfully signed into the application is a trusted staff member with the authority to manage all data. Therefore, all read and write operations are granted to any authenticated user, while anonymous access is strictly denied.
 *
 * Data Structure:
 * - /choirs/{choirId}: Contains information about each choir group.
 * - /choirs/{choirId}/members/{admissionNumber}: A sub-collection tracking which students are in which choir.
 * - /students/{admissionNumber}: Contains general information about each student.
 * - /choir_attendance/{attendanceId}: Stores attendance records for choir practices.
 * This structure is designed for performance and scalability.
 *
 * Key Security Decisions:
 * - Authenticated Users Only: All access to data (read, write, delete) requires a user to be signed in.
 * - Audit Trail Integrity: The rules enforce that the creator's user ID is correctly recorded at the time of creation and cannot be modified later.
 * - No Data Shape Validation: The focus is solely on authorization, not schema enforcement.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isExistingDoc() {
      return resource != null;
    }

    // --- Student Functions ---
    function hasValidStudentDataOnCreate() {
      return request.resource.data.uploadedBy == request.auth.uid;
    }
    function isStudentUploaderImmutable() {
      return request.resource.data.uploadedBy == resource.data.uploadedBy;
    }

    // --- Choir Functions ---
    function hasValidChoirDataOnCreate() {
        return request.resource.data.createdBy == request.auth.uid;
    }
    function isChoirCreatorImmutable() {
        return request.resource.data.createdBy == resource.data.createdBy;
    }

    // --- Choir Member Functions ---
    function hasValidChoirMemberDataOnCreate() {
      return request.resource.data.addedBy == request.auth.uid;
    }
    function isChoirMemberAdderImmutable() {
      return request.resource.data.addedBy == resource.data.addedBy;
    }

    // --- Attendance Functions ---
    function hasValidAttendanceDataOnCreate() {
      return request.resource.data.recordedBy == request.auth.uid;
    }
    function isAttendanceRecorderImmutable() {
      return request.resource.data.recordedBy == resource.data.recordedBy;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages choir groups. Any authenticated user can create, read, or write choir data.
     */
    match /choirs/{choirId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && hasValidChoirDataOnCreate();
      allow update: if isSignedIn() && isExistingDoc() && isChoirCreatorImmutable();
      allow delete: if isSignedIn() && isExistingDoc();
      
      /**
       * @description Manages members within a specific choir.
       */
      match /members/{admissionNumber} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && hasValidChoirMemberDataOnCreate();
        allow update: if isSignedIn() && isExistingDoc() && isChoirMemberAdderImmutable();
        allow delete: if isSignedIn() && isExistingDoc();
      }
    }

    /**
     * @description Manages student records. Any authenticated user can read or write student data.
     */
    match /students/{admissionNumber} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && hasValidStudentDataOnCreate();
      allow update: if isSignedIn() && isExistingDoc() && isStudentUploaderImmutable();
      allow delete: if isSignedIn() && isExistingDoc();
    }

    /**
     * @description Manages choir attendance records.
     */
    match /choir_attendance/{attendanceId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && hasValidAttendanceDataOnCreate();
      allow update: if isSignedIn() && isExistingDoc() && isAttendanceRecorderImmutable();
      allow delete: if isSignedIn() && isExistingDoc();
    }
  }
}
