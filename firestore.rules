/**
 * Core Philosophy: This ruleset enforces a secure "Authenticated Read, Owner Write" model.
 * Any user who is signed into the application can read data from any collection.
 * Write operations (create, update, delete) are strictly controlled based on document ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    match /students/{admissionNumber} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.uploaded_by);
      allow update: if isSignedIn() && resource != null && isOwner(resource.data.uploaded_by) && isImmutable('uploaded_by');
      allow delete: if isSignedIn() && resource != null && isOwner(resource.data.uploaded_by);
    }

    match /choirs/{choirId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.created_by);
      allow update: if isSignedIn() && resource != null && isOwner(resource.data.created_by) && isImmutable('created_by');
      allow delete: if isSignedIn() && resource != null && isOwner(resource.data.created_by);

      match /members/{admissionNumber} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && isOwner(request.resource.data.added_by);
        allow update: if isSignedIn() && resource != null && isOwner(resource.data.added_by) && isImmutable('added_by');
        allow delete: if isSignedIn() && resource != null && isOwner(resource.data.added_by);
      }
    }

    // Support collectionGroup queries for members across all choirs (Dashboard)
    match /{path=**}/members/{admissionNumber} {
      allow read: if isSignedIn();
    }

    match /choir_attendance/{attendanceId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.recorded_by);
      allow update: if isSignedIn() && resource != null && isOwner(resource.data.recorded_by) && isImmutable('recorded_by');
      allow delete: if isSignedIn() && resource != null && isOwner(resource.data.recorded_by);
    }

    match /custom_lists/{listId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn(); // Shared workspace for custom event planning
    }
  }
}
